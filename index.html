<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‰ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ v3.02 +Guide</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --accent-color: #ff4081;
            --card-bg: #2d2d2d;
            --border-color: #444;
            --input-bg: #444;
            --input-border: #666;
            --error-color: #ff5252;
            --success-color: #4caf50;
            --lock-active: #ffd700;
            --row-hover: #383838;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header-wrapper {
            position: relative;
            width: 100%;
            max-width: 600px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 10px;
            box-sizing: border-box;
        }

        h1 {
            color: var(--accent-color);
            font-size: 1.8rem;
            margin: 0;
            text-align: center;
        }

        .header-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            color: #777;
            border: 1px solid #444;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
            white-space: nowrap;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-btn:hover {
            background: #333;
            color: #fff;
            border-color: #888;
        }

        .refresh-btn { right: 0; }
        .help-btn { left: 0; font-weight: bold; width: 24px; height: 24px; padding: 0; font-size: 0.9rem; }

        .container {
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .section {
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 2px solid var(--accent-color);
            display: inline-block;
            padding-bottom: 3px;
        }

        .option-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 5px;
        }

        .option-row label {
            margin-right: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        input[type="text"] {
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
        }

        input.numeric-input {
            width: 50px;
            text-align: center;
            padding: 4px;
            transition: border-color 0.2s, background-color 0.2s;
        }

        input.numeric-input[readonly] {
            background: #222;
            color: #777;
            border-color: #333;
            cursor: not-allowed;
        }

        input.numeric-input:disabled {
            background: #333;
            color: #777;
            border-color: #444;
        }

        input.numeric-input.input-error {
            border: 2px solid var(--error-color);
            background-color: rgba(255, 82, 82, 0.1);
        }

        .error-msg {
            color: var(--error-color);
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 5px;
            display: none;
        }

        .error-msg.visible {
            display: inline-block;
        }
        
        input[type="radio"], input[type="checkbox"] {
            transform: scale(1.2);
            accent-color: var(--accent-color);
            margin-right: 5px;
        }

        .folder-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .folder-row-item {
            display: flex;
            flex-wrap: nowrap; 
            align-items: center;
            justify-content: space-between;
            background-color: rgba(255, 255, 255, 0.05);
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid transparent;
            transition: background-color 0.2s;
        }

        .folder-row-item:hover {
            background-color: var(--row-hover);
            border-color: #555;
        }

        .folder-left-col {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex-grow: 1;
        }

        .folder-title-row {
            display: flex;
            align-items: center;
        }

        .folder-settings-row {
            display: flex;
            align-items: center;
            padding-left: 28px;
        }

        .folder-right-col {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-left: 10px;
            flex-shrink: 0; 
        }

        .range-inline {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            font-size: 0.9rem;
            color: #ccc;
        }

        .range-group {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            color: #aaa;
        }

        .prob-input-group {
            display: inline-flex;
            align-items: center;
            font-size: 0.85rem;
            color: #ffb74d;
            margin-right: 10px;
        }

        .prob-unit {
            font-size: 0.8rem;
            color: #aaa;
        }

        .lock-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0 4px;
            line-height: 1;
            filter: grayscale(100%) opacity(0.5);
            transition: all 0.2s;
        }

        .lock-btn.locked {
            filter: none;
            text-shadow: 0 0 5px var(--lock-active);
            opacity: 1;
        }

        button#roll-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s;
        }

        button#roll-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        button#roll-btn:active {
            transform: translateY(0);
        }

        button#roll-btn:disabled {
            background-color: #555;
            cursor: not-allowed;
            transform: none;
            opacity: 0.7;
        }

        #result-area {
            margin-top: 20px;
            padding: 20px;
            background-color: #000;
            border: 2px solid var(--accent-color);
            border-radius: 8px;
            min-height: 120px;
            display: none;
        }

        .result-line {
            font-size: 1.2rem;
            margin: 15px 0;
            line-height: 1.4;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        .result-line:last-child {
            border-bottom: none;
        }

        .result-label {
            color: #aaa;
            font-size: 0.9rem;
            min-width: 100px;
        }

        .result-value {
            color: #fff;
            font-weight: bold;
            font-size: 1.3rem;
            text-align: right;
            word-break: break-word;
            max-width: 70%;
        }

        .folder-name {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 4px;
        }

        .song-info {
            font-size: 1.6rem; 
            color: #81d4fa;
            line-height: 1.2;
        }

        .rolling-text {
            color: #666;
            opacity: 0.7;
            text-shadow: none;
            transition: color 0.1s;
        }

        .waiting-text {
            font-size: 1.1rem;
            color: #555;
            font-style: italic;
            animation: pulse 0.8s infinite alternate;
        }

        @keyframes pulse {
            0% { opacity: 0.4; }
            100% { opacity: 1; text-shadow: 0 0 5px rgba(255, 64, 129, 0.3); }
        }

        .locked-flash {
            animation: flashEffect 0.5s ease-out;
            color: #fff;
            text-shadow: 0 0 10px var(--accent-color);
            opacity: 1;
        }

        @keyframes flashEffect {
            0% { transform: scale(1.2); color: #fff; text-shadow: 0 0 20px #fff; }
            100% { transform: scale(1); color: #fff; text-shadow: none; }
        }

        #loading-status {
            text-align: center;
            color: #aaa;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .footer {
            margin-top: 40px;
            margin-bottom: 10px;
            color: #444;
            font-size: 0.75rem;
            text-align: center;
            font-family: monospace;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--card-bg);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            border-radius: 8px;
            border: 1px solid var(--accent-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-header {
            padding: 15px;
            background: #222;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--accent-color);
        }

        .close-modal {
            background: transparent;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
            line-height: 1.6;
        }

        .help-section { margin-bottom: 20px; }
        .help-section h4 { 
            color: var(--accent-color); 
            margin-bottom: 8px; 
            border-bottom: 1px solid #444;
            padding-bottom: 4px;
        }
        .help-section ul { padding-left: 20px; margin: 0; font-size: 0.95rem; }
        .help-section li { margin-bottom: 5px; }

        .rule-group {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            border: 1px solid #555;
        }

        .rule-group-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #555;
            padding-bottom: 5px;
        }

        .rule-items-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .rule-item-row {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .rule-item-row input[type="text"]:not(.numeric-input) {
            flex-grow: 1;
            width: auto;
        }

        .rule-btn {
            background: #444;
            border: 1px solid #666;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .rule-btn:hover {
            background: #555;
        }

        .add-rule-btn {
            width: 100%;
            margin-top: 10px;
            padding: 5px;
            background: #2a2a2a;
            height: auto;
        }

        .detail-btn {
            background: transparent;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            padding: 2px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 10px;
        }
        
        .detail-btn:hover {
            background: var(--accent-color);
            color: white;
        }

        @media (max-width: 450px) {
            .refresh-btn { right: 0; }
            .help-btn { left: 0; }
            .header-wrapper {
                flex-direction: row; 
                justify-content: center;
            }
            .folder-row-item {
                flex-direction: row; 
                align-items: center;
            }
            .folder-left-col { width: 100%; }
            .folder-right-col { justify-content: flex-end; }
        }
    </style>
</head>
<body>

    <div class="header-wrapper">
        <button class="header-btn help-btn" id="open-help-btn" title="ä½¿ã„æ–¹">ï¼Ÿ</button>
        <h1>ãƒ‰ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ v3.02</h1>
        <button class="header-btn refresh-btn" id="force-reload" title="Reload">â†» RELOAD</button>
    </div>

    <div id="loading-status">Database Loading...</div>

    <div class="container">
        
        <div class="section">
            <div class="section-title">ãƒ¢ãƒ¼ãƒ‰è¨­å®š</div>
            <div class="option-row">
                <input type="radio" id="mode-song-on" name="song-mode" value="on" checked>
                <label for="mode-song-on">æ›²åã‚ã‚Š</label>
                
                <input type="radio" id="mode-song-off" name="song-mode" value="off" style="margin-left: 20px;">
                <label for="mode-song-off">æ›²åãªã—</label>
            </div>
        </div>

        <div class="section">
            <div class="section-title">ã‚²ãƒ¼ã‚¸</div>
            
            <div class="option-row">
                <input type="checkbox" id="chk-dani" checked class="gauge-group">
                <label for="chk-dani">æ®µä½</label>
                <div class="range-group">
                    <input type="text" id="dani-min" value="2" class="numeric-input">% - 
                    <input type="text" id="dani-max" value="100" class="numeric-input">%
                    <span class="error-msg">Error</span>
                </div>
            </div>

            <div class="option-row">
                <input type="checkbox" id="chk-erosion" checked class="gauge-group">
                <label for="chk-erosion">ä¾µè•</label>
                <div class="range-group">
                    <input type="text" id="erosion-min" value="1" class="numeric-input">â˜… - 
                    <input type="text" id="erosion-max" value="5" class="numeric-input">â˜…
                    <span class="error-msg">Error</span>
                </div>
            </div>

            <div class="option-row">
                <input type="checkbox" id="chk-exh" checked class="gauge-group">
                <label for="chk-exh">EXH</label>
            </div>
            
            <div class="option-row">
                <input type="checkbox" id="chk-hard" checked class="gauge-group">
                <label for="chk-hard">HARD</label>
            </div>

            <div class="option-row">
                <input type="checkbox" id="chk-normal" checked class="gauge-group">
                <label for="chk-normal">NORMAL</label>
            </div>
        </div>

        <div class="section">
            <div class="section-title">ãƒ•ã‚©ãƒ«ãƒ€</div>
            <div class="folder-list">
                
                <div class="folder-row-item">
                    <div class="folder-left-col">
                        <div class="folder-title-row">
                            <input type="checkbox" id="chk-level" checked class="folder-group folder-chk">
                            <label for="chk-level">ãƒ¬ãƒ™ãƒ«ãƒ•ã‚©ãƒ«ãƒ€</label>
                        </div>
                        <div class="folder-settings-row">
                            <div class="range-inline">
                                <span style="color:#aaa;">â˜…</span>
                                <input type="text" id="level-min" value="1" class="numeric-input" style="width:30px; padding:2px;">
                                <span>-</span>
                                <input type="text" id="level-max" value="12" class="numeric-input" style="width:30px; padding:2px;">
                                <span class="error-msg">Error</span>
                            </div>
                        </div>
                    </div>
                    <div class="folder-right-col">
                        <input type="text" id="prob-level" value="50" class="folder-prob numeric-input">
                        <span class="prob-unit">%</span>
                        <button class="lock-btn" onclick="toggleLock(this)">ğŸ”“</button>
                    </div>
                </div>

                <div class="folder-row-item">
                    <div class="folder-left-col">
                        <div class="folder-title-row">
                            <input type="checkbox" id="chk-dahlia" checked class="folder-group folder-chk">
                            <label for="chk-dahlia">ãƒ€ãƒªã‚¢ãƒ•ã‚©ãƒ«ãƒ€</label>
                        </div>
                    </div>
                    <div class="folder-right-col">
                        <input type="text" id="prob-dahlia" value="50" class="folder-prob numeric-input">
                        <span class="prob-unit">%</span>
                        <button class="lock-btn" onclick="toggleLock(this)">ğŸ”“</button>
                    </div>
                </div>

                <div class="folder-row-item">
                    <div class="folder-left-col">
                        <div class="folder-title-row">
                            <input type="checkbox" id="chk-all-songs" class="folder-group folder-chk">
                            <label for="chk-all-songs">å…¨æ›²ãƒ•ã‚©ãƒ«ãƒ€</label>
                        </div>
                    </div>
                    <div class="folder-right-col">
                        <input type="text" id="prob-all-songs" value="0" class="folder-prob numeric-input" disabled>
                        <span class="prob-unit">%</span>
                        <button class="lock-btn" onclick="toggleLock(this)">ğŸ”“</button>
                    </div>
                </div>

            </div>
            <div class="error-msg" id="folder-prob-error" style="margin-top: 8px; text-align: right;">ç¢ºç‡ã®åˆè¨ˆãŒ100%ã§ã¯ã‚ã‚Šã¾ã›ã‚“</div>
        </div>

        <div class="section">
            <div class="section-title">ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ”ãƒ¼ãƒ‰</div>
            <div class="option-row">
                <div class="range-group" style="color: var(--text-color);">
                    x <input type="text" id="speed-min" value="0.70" class="numeric-input" style="width:60px;"> - 
                    x <input type="text" id="speed-max" value="1.50" class="numeric-input" style="width:60px;">
                    <span class="error-msg">Error</span>
                    <span style="font-size:0.8rem; color:#888; margin-left:10px;">(STEP: 0.05)</span>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">ç‰¹åˆ¥ãƒ«ãƒ¼ãƒ« (ä»»æ„)</div>
            <div class="option-row">
                <span>ç‰¹åˆ¥ãƒ«ãƒ¼ãƒ«ã‚’æœ‰åŠ¹ã«ã™ã‚‹å ´åˆã¯ã€Œè©³ç´°ã€ã‹ã‚‰è¨­å®šã—ã¦ãã ã•ã„</span>
                <button class="detail-btn" id="open-rules-btn">è©³ç´°è¨­å®š</button>
            </div>
        </div>

        <button id="roll-btn" disabled>LOADING DATA...</button>

        <div id="result-area"></div>
    </div>

    <div class="modal-overlay" id="help-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h3>
                <button class="close-modal" id="close-help-btn">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="help-section">
                    <h4>1. ãƒ¢ãƒ¼ãƒ‰è¨­å®š</h4>
                    <ul>
                        <li><b>æ›²åã‚ã‚Š</b>: æ¥½æ›²åã¨é›£æ˜“åº¦ã¾ã§æŠ½é¸ã—ã¾ã™ã€‚</li>
                        <li><b>æ›²åãªã—</b>: ãƒ•ã‚©ãƒ«ãƒ€åã®ã¿ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</li>
                    </ul>
                </div>
                <div class="help-section">
                    <h4>2. ã‚²ãƒ¼ã‚¸è¨­å®š</h4>
                    <ul>
                        <li>ã‚²ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã§æ±ºå®šã—ã¾ã™ã€‚</li>
                        <li>æ®µä½ã‚„ä¾µè•ã¯æ•°å€¤ã®ç¯„å›²ï¼ˆMin - Maxï¼‰ã‚’æŒ‡å®šå¯èƒ½ã§ã™ã€‚</li>
                    </ul>
                </div>
                <div class="help-section">
                    <h4>3. ãƒ•ã‚©ãƒ«ãƒ€è¨­å®š & ç¢ºç‡èª¿æ•´</h4>
                    <ul>
                        <li>ãƒ¬ãƒ™ãƒ«ã€ãƒ€ãƒªã‚¢ã€å…¨æ›²ã®3ç¨®é¡ã‹ã‚‰æŠ½é¸å¯¾è±¡ã‚’é¸ã¹ã¾ã™ã€‚</li>
                        <li>ãƒ¬ãƒ™ãƒ«ãƒ•ã‚©ãƒ«ãƒ€ãŒè¤‡æ•°ãƒ¬ãƒ™ãƒ«ã‚’å«ã‚€å ´åˆã€å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸç¢ºç‡ã¯å„ãƒ¬ãƒ™ãƒ«ã«ç­‰åˆ†ã•ã‚Œã¾ã™ã€‚</li>
                    </ul>
                </div>
                <div class="help-section">
                    <h4>4. ç‰¹åˆ¥ãƒ«ãƒ¼ãƒ« (Special Rules)</h4>
                    <ul>
                        <li>ç‹¬è‡ªã®ã€Œç¸›ã‚Šã€ã‚„ã€Œã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€ã‚’è¿½åŠ ã§ãã¾ã™ã€‚</li>
                        <li>ã€Œè©³ç´°è¨­å®šã€ã‹ã‚‰æœ€å¤§3ã¤ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆå¯èƒ½ã§ã™ã€‚</li>
                        <li>é …ç›®åã¨ç¢ºç‡ï¼ˆ%ï¼‰ã‚’è‡ªç”±ã«è¨­å®šã—ã€æŠ½é¸çµæœã«è¿½åŠ è¡¨ç¤ºã§ãã¾ã™ã€‚</li>
                    </ul>
                </div>
                <div class="help-section">
                    <h4>5. ç¢ºç‡ã«ã¤ã„ã¦</h4>
                    <ul>
                        <li><b>è‡ªå‹•èª¿æ•´</b>: ç¢ºç‡ã‚’å¤‰æ›´ã™ã‚‹ã¨ã€ä»–ã®é …ç›®ã®æ•°å€¤ãŒè‡ªå‹•çš„ã«èª¿æ•´ã•ã‚Œã€åˆè¨ˆãŒ100%ã«ãªã‚Šã¾ã™ã€‚</li>
                        <li><b>ãƒ­ãƒƒã‚¯æ©Ÿèƒ½ (ğŸ”“)</b>: éµã‚¢ã‚¤ã‚³ãƒ³ã‚’æŠ¼ã™ã¨ç¢ºç‡ã‚’å›ºå®šã§ãã¾ã™ã€‚å›ºå®šã•ã‚ŒãŸæ•°å€¤ã¯è‡ªå‹•èª¿æ•´ã®å½±éŸ¿ã‚’å—ã‘ã¾ã›ã‚“ã€‚</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="rules-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç‰¹åˆ¥ãƒ«ãƒ¼ãƒ«è¨­å®š</h3>
                <button class="close-modal" id="close-rules-btn">Ã—</button>
            </div>
            <div class="modal-body" id="rules-container">
                <div class="rule-group" data-id="0">
                    <div class="rule-group-header">
                        <input type="checkbox" class="rule-enable-chk" id="rule-chk-0">
                        <input type="text" class="rule-group-name" value="ã‚ªãƒ—ã‚·ãƒ§ãƒ³1" placeholder="é …ç›®å">
                    </div>
                    <div class="rule-items-container" id="rule-items-0"></div>
                    <button class="rule-btn add-rule-btn" onclick="addRuleItem(0)">+ é …ç›®ã‚’è¿½åŠ </button>
                    <div class="error-msg rule-prob-error">ç¢ºç‡åˆè¨ˆâ‰ 100%</div>
                </div>

                <div class="rule-group" data-id="1">
                    <div class="rule-group-header">
                        <input type="checkbox" class="rule-enable-chk" id="rule-chk-1">
                        <input type="text" class="rule-group-name" value="ã‚ªãƒ—ã‚·ãƒ§ãƒ³2" placeholder="é …ç›®å">
                    </div>
                    <div class="rule-items-container" id="rule-items-1"></div>
                    <button class="rule-btn add-rule-btn" onclick="addRuleItem(1)">+ é …ç›®ã‚’è¿½åŠ </button>
                    <div class="error-msg rule-prob-error">ç¢ºç‡åˆè¨ˆâ‰ 100%</div>
                </div>

                <div class="rule-group" data-id="2">
                    <div class="rule-group-header">
                        <input type="checkbox" class="rule-enable-chk" id="rule-chk-2">
                        <input type="text" class="rule-group-name" value="ã‚ªãƒ—ã‚·ãƒ§ãƒ³3" placeholder="é …ç›®å">
                    </div>
                    <div class="rule-items-container" id="rule-items-2"></div>
                    <button class="rule-btn add-rule-btn" onclick="addRuleItem(2)">+ é …ç›®ã‚’è¿½åŠ </button>
                    <div class="error-msg rule-prob-error">ç¢ºç‡åˆè¨ˆâ‰ 100%</div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">Created by DEDEDE with Gemini | Version 260207 v3.02 +Guide</div>

    <script>
        // --- Full-width to Half-width Normalizer ---
        function normalizeInput(el) {
            let val = el.value;
            val = val.replace(/[ï¼-ï¼™]/g, function(s) {
                return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
            });
            val = val.replace(/[^0-9.]/g, '');
            const dots = val.split('.');
            if (dots.length > 2) {
                val = dots[0] + '.' + dots.slice(1).join('');
            }
            if (el.value !== val) {
                el.value = val;
            }
        }

        window.toggleLock = function(btn) {
            const input = btn.previousElementSibling.previousElementSibling; 
            if(!input) return;

            if (btn.classList.contains('locked')) {
                btn.classList.remove('locked');
                btn.textContent = "ğŸ”“";
                input.readOnly = false;
            } else {
                btn.classList.add('locked');
                btn.textContent = "ğŸ”’";
                input.readOnly = true;
            }
            if(typeof validateAll === 'function') validateAll();
        };

        function isLocked(input) {
            return input.readOnly;
        }

        function rebalanceProbabilities(changedInput, allInputs) {
            const newVal = Math.min(100, Math.max(0, parseInt(changedInput.value) || 0));
            changedInput.value = newVal; 
            
            const siblings = Array.from(allInputs).filter(i => i !== changedInput);
            const unlockedSiblings = siblings.filter(i => !isLocked(i));

            if (unlockedSiblings.length === 0) return;

            const lockedSum = siblings.filter(i => isLocked(i)).reduce((sum, i) => sum + (parseInt(i.value)||0), 0);
            const remainingSpace = 100 - newVal - lockedSum;

            if (remainingSpace < 0) {
                unlockedSiblings.forEach(i => i.value = 0);
                return;
            }

            let currentUnlockedTotal = unlockedSiblings.reduce((sum, input) => sum + (parseInt(input.value) || 0), 0);
            
            if (currentUnlockedTotal === 0) {
                const count = unlockedSiblings.length;
                const base = Math.floor(remainingSpace / count);
                const rem = remainingSpace % count;
                unlockedSiblings.forEach((input, index) => {
                    input.value = base + (index < rem ? 1 : 0);
                });
                return;
            }

            let distributedSum = 0;
            unlockedSiblings.forEach((input, index) => {
                if (index === unlockedSiblings.length - 1) {
                    input.value = Math.max(0, remainingSpace - distributedSum);
                } else {
                    const currentVal = parseInt(input.value) || 0;
                    const ratio = currentVal / currentUnlockedTotal;
                    const nextVal = Math.round(remainingSpace * ratio);
                    input.value = nextVal;
                    distributedSum += nextVal;
                }
            });
        }

        window.addRuleItem = function(groupId, text = "", prob = null) {
            const container = document.getElementById(`rule-items-${groupId}`);
            if(!container) return;

            const div = document.createElement('div');
            div.className = 'rule-item-row';
            
            const startVal = (container.children.length === 0) ? 100 : 0;

            div.innerHTML = `
                <input type="text" value="${text}" placeholder="é¸æŠè‚¢">
                <span class="prob-input-group">
                    (<input type="text" value="${startVal}" class="rule-item-prob numeric-input">%)
                    <span class="prob-unit" style="display:none;"></span>
                    <button class="lock-btn" onclick="toggleLock(this)">ğŸ”“</button>
                </span>
                <button class="rule-btn remove-rule-btn" onclick="removeRuleItem(this, ${groupId})">-</button>
            `;
            container.appendChild(div);

            const input = div.querySelector('.rule-item-prob');
            // Attach Normalizer
            input.addEventListener('input', function() {
                normalizeInput(this);
                const all = container.querySelectorAll('.rule-item-prob');
                rebalanceProbabilities(this, all);
                if(typeof validateAll === 'function') validateAll();
            });

            if(typeof validateAll === 'function') validateAll();
        };

        window.removeRuleItem = function(btn, groupId) {
            const container = document.getElementById(`rule-items-${groupId}`);
            const row = btn.parentElement;
            const input = row.querySelector('.rule-item-prob');
            
            const valToRemove = parseInt(input.value) || 0;
            row.remove();
            
            const remainingInputs = container.querySelectorAll('.rule-item-prob');
            const unlocked = Array.from(remainingInputs).filter(i => !isLocked(i));
            
            if (unlocked.length > 0 && valToRemove > 0) {
                const add = Math.floor(valToRemove / unlocked.length);
                const rem = valToRemove % unlocked.length;
                unlocked.forEach((inp, idx) => {
                    let v = parseInt(inp.value)||0;
                    inp.value = v + add + (idx < rem ? 1 : 0);
                });
            }

            if(typeof validateAll === 'function') validateAll();
        };

        let songData = [];

        document.getElementById('force-reload').addEventListener('click', function() {
            const url = new URL(window.location.href);
            url.searchParams.set('t', Date.now());
            window.location.href = url.toString();
        });

        // Setup Modals
        function setupModals() {
            // Help Modal
            const helpModal = document.getElementById('help-modal');
            const openHelp = document.getElementById('open-help-btn');
            const closeHelp = document.getElementById('close-help-btn');
            
            if(openHelp) openHelp.addEventListener('click', () => { helpModal.style.display = 'flex'; });
            if(closeHelp) closeHelp.addEventListener('click', () => { helpModal.style.display = 'none'; });

            // Rules Modal
            const rulesModal = document.getElementById('rules-modal');
            const openRules = document.getElementById('open-rules-btn');
            const closeRules = document.getElementById('close-rules-btn');
            
            if(openRules) openRules.addEventListener('click', () => { rulesModal.style.display = 'flex'; validateAll(); });
            if(closeRules) closeRules.addEventListener('click', () => { rulesModal.style.display = 'none'; validateAll(); });
        }

        window.addEventListener('DOMContentLoaded', () => {
            initProbabilityLogic();
            initValidationLogic();
            initSpecialRulesLogic();
            setupModals();

            fetch('./songs.json?t=' + Date.now())
                .then(response => {
                    if (!response.ok) throw new Error("HTTP Error " + response.status);
                    return response.json();
                })
                .then(data => {
                    songData = data;
                    document.getElementById('loading-status').textContent = "Database Loaded: " + songData.length + " songs.";
                    document.getElementById('loading-status').style.color = "#4caf50";
                    validateAll();
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('loading-status').textContent = "Failed to load songs.json.";
                    document.getElementById('loading-status').style.color = "#f44336";
                });
        });

        function initProbabilityLogic() {
            const chkLevel = document.getElementById('chk-level');
            const chkDahlia = document.getElementById('chk-dahlia');
            const chkAll = document.getElementById('chk-all-songs');
            
            const probLevel = document.getElementById('prob-level');
            const probDahlia = document.getElementById('prob-dahlia');
            const probAll = document.getElementById('prob-all-songs');

            const allChks = [chkLevel, chkDahlia, chkAll];
            const allProbs = [probLevel, probDahlia, probAll];

            function getActiveProbs() {
                const active = [];
                if(chkLevel.checked) active.push(probLevel);
                if(chkDahlia.checked) active.push(probDahlia);
                if(chkAll.checked) active.push(probAll);
                return active;
            }

            function updateInputs() {
                probLevel.disabled = !chkLevel.checked;
                probDahlia.disabled = !chkDahlia.checked;
                probAll.disabled = !chkAll.checked;

                const active = getActiveProbs();
                if (active.length > 0) {
                    const base = Math.floor(100 / active.length);
                    const rem = 100 % active.length;
                    active.forEach((inp, i) => {
                        if(!isLocked(inp)) {
                            inp.value = base + (i<rem ? 1:0);
                        }
                    });
                }
                validateAll();
            }

            allChks.forEach(chk => chk.addEventListener('change', updateInputs));
            
            allProbs.forEach(prob => {
                prob.addEventListener('input', function() {
                    normalizeInput(this);
                    const active = getActiveProbs();
                    if(active.length > 1) {
                        rebalanceProbabilities(this, active);
                    }
                    validateAll();
                });
            });
        }

        function initSpecialRulesLogic() {
            const rulesContainer = document.getElementById('rules-container');
            // Default Items
            for(let i=0; i<3; i++) {
                addRuleItem(i, "é …ç›®A");
                addRuleItem(i, "é …ç›®B");
            }
        }

        function initValidationLogic() {
            const inputs = document.querySelectorAll('input.numeric-input');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    normalizeInput(this);
                    validateAll();
                });
                input.addEventListener('change', validateAll);
            });
        }

        function validateAll() {
            let isValid = true;
            const btn = document.getElementById('roll-btn');
            const errorFolder = document.getElementById('folder-prob-error');

            if(!btn) return;

            const gaugeChecked = Array.from(document.querySelectorAll('.gauge-group')).some(c => c.checked);
            const folderChecked = Array.from(document.querySelectorAll('.folder-group')).some(c => c.checked);

            if (!gaugeChecked || !folderChecked) isValid = false;

            let folderSum = 0;
            document.querySelectorAll('.folder-prob').forEach(p => {
                if(!p.disabled) folderSum += (parseInt(p.value) || 0);
            });
            
            if (folderChecked && folderSum !== 100) {
                isValid = false;
                if(errorFolder) errorFolder.classList.add('visible');
            } else {
                if(errorFolder) errorFolder.classList.remove('visible');
            }

            function checkField(id, min, max, isEnabled) {
                const el = document.getElementById(id);
                if(!el) return true;
                const parent = el.closest('.range-group, .range-inline');
                const errorSpan = parent ? parent.querySelector('.error-msg') : null;
                
                if (!isEnabled) {
                    el.classList.remove('input-error');
                    return true;
                }
                const val = parseFloat(el.value);
                if (isNaN(val) || val < min || val > max) {
                    el.classList.add('input-error');
                    if(errorSpan) errorSpan.classList.add('visible');
                    return false;
                } else {
                    el.classList.remove('input-error');
                    if(errorSpan) errorSpan.classList.remove('visible');
                    return true;
                }
            }

            if (!checkField('dani-min', 2, 100, document.getElementById('chk-dani').checked)) isValid = false;
            if (!checkField('dani-max', 2, 100, document.getElementById('chk-dani').checked)) isValid = false;
            if (!checkField('erosion-min', 1, 5, document.getElementById('chk-erosion').checked)) isValid = false;
            if (!checkField('erosion-max', 1, 5, document.getElementById('chk-erosion').checked)) isValid = false;
            if (!checkField('speed-min', 0.70, 1.50, true)) isValid = false;
            if (!checkField('speed-max', 0.70, 1.50, true)) isValid = false;
            if (!checkField('level-min', 1, 12, document.getElementById('chk-level').checked)) isValid = false;
            if (!checkField('level-max', 1, 12, document.getElementById('chk-level').checked)) isValid = false;

            for (let i = 0; i < 3; i++) {
                const groupDiv = document.querySelector(`.rule-group[data-id="${i}"]`);
                if(groupDiv) {
                    const enabled = groupDiv.querySelector('.rule-enable-chk').checked;
                    const errorMsg = groupDiv.querySelector('.rule-prob-error');
                    
                    if (enabled) {
                        let sum = 0;
                        const items = groupDiv.querySelectorAll('.rule-item-prob');
                        if (items.length === 0) {
                            isValid = false; 
                            errorMsg.classList.add('visible');
                        } else {
                            items.forEach(inp => sum += (parseInt(inp.value) || 0));
                            if (sum !== 100) {
                                isValid = false;
                                errorMsg.classList.add('visible');
                            } else {
                                errorMsg.classList.remove('visible');
                            }
                        }
                    } else {
                        errorMsg.classList.remove('visible');
                    }
                }
            }

            if (songData.length > 0) {
                if (isValid) {
                    btn.disabled = false;
                    btn.textContent = "START";
                } else {
                    btn.disabled = true;
                    btn.textContent = "ERROR (æ¡ä»¶ã‚’ç¢ºèªã—ã¦ãã ã•ã„)";
                }
            }
        }

        function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function getRandomStep(min, max, step) {
            const steps = Math.floor((max - min) / step);
            const randomStep = Math.floor(Math.random() * (steps + 1));
            return parseFloat((min + (randomStep * step)).toFixed(2));
        }

        function pickSongByLevel(level) {
            if (!songData.length) return null;
            const candidates = songData.filter(song => {
                const s = song.levels.sp;
                return s.n==level || s.h==level || s.a==level || s.l==level;
            });
            if (!candidates.length) return null;
            const song = candidates[Math.floor(Math.random() * candidates.length)];
            const types = [];
            if (song.levels.sp.n == level) types.push('n');
            if (song.levels.sp.h == level) types.push('h');
            if (song.levels.sp.a == level) types.push('a');
            if (song.levels.sp.l == level) types.push('l');
            return { song: song, type: types[Math.floor(Math.random() * types.length)] };
        }

        function pickSongByDahlia() {
            if (!songData.length) return null;
            const candidates = songData.filter(s => s.levels.sp.l > 0);
            if (!candidates.length) return null;
            return { song: candidates[Math.floor(Math.random() * candidates.length)], type: 'l' };
        }

        function pickAnySong() {
            if (!songData.length) return null;
            const song = songData[Math.floor(Math.random() * songData.length)];
            const types = [];
            if (song.levels.sp.n > 0) types.push('n');
            if (song.levels.sp.h > 0) types.push('h');
            if (song.levels.sp.a > 0) types.push('a');
            if (song.levels.sp.l > 0) types.push('l');
            if(types.length === 0) return { song: song, type: 'a' };
            return { song: song, type: types[Math.floor(Math.random() * types.length)] };
        }

        function getDifficultySuffix(type) {
            if (type === 'n') return '(N)';
            if (type === 'h') return '(H)';
            if (type === 'a') return '(A)';
            if (type === 'l') return '(å¢“)';
            return '';
        }

        function generateResultsArray() {
            const results = [];

            const gauges = [];
            const chkDani = document.getElementById('chk-dani');
            const chkEro = document.getElementById('chk-erosion');
            
            if (chkDani.checked) {
                gauges.push({ type: 'æ®µä½', hasVal: true, 
                    min: parseInt(document.getElementById('dani-min').value), 
                    max: parseInt(document.getElementById('dani-max').value), suffix: '%' });
            }
            if (chkEro.checked) {
                gauges.push({ type: 'ä¾µè•', hasVal: true, 
                    min: parseInt(document.getElementById('erosion-min').value), 
                    max: parseInt(document.getElementById('erosion-max').value), suffix: 'â˜…' });
            }
            if (document.getElementById('chk-exh').checked) gauges.push({ type: 'EXH', hasVal: false });
            if (document.getElementById('chk-hard').checked) gauges.push({ type: 'HARD', hasVal: false });
            if (document.getElementById('chk-normal').checked) gauges.push({ type: 'NORMAL', hasVal: false });

            let gRes = "ãªã—";
            if (gauges.length > 0) {
                const sel = gauges[Math.floor(Math.random() * gauges.length)];
                if (sel.hasVal) {
                    const rMin = Math.min(sel.min, sel.max);
                    const rMax = Math.max(sel.min, sel.max);
                    let val;
                    if(sel.type === 'æ®µä½') {
                        val = getRandomInt(Math.ceil(rMin/2), Math.floor(rMax/2)) * 2;
                    } else {
                        val = getRandomInt(rMin, rMax);
                    }
                    gRes = `${sel.type} ${val}${sel.suffix}`;
                } else {
                    gRes = sel.type;
                }
            }
            results.push({ label: "ã‚²ãƒ¼ã‚¸", value: gRes });

            const sMin = parseFloat(document.getElementById('speed-min').value);
            const sMax = parseFloat(document.getElementById('speed-max').value);
            const sVal = getRandomStep(Math.min(sMin, sMax), Math.max(sMin, sMax), 0.05);
            results.push({ label: "ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ”ãƒ¼ãƒ‰", value: `x${sVal.toFixed(2)}` });

            const folders = [];
            if(document.getElementById('chk-level').checked) {
                folders.push({ type: 'lvl', w: parseInt(document.getElementById('prob-level').value)||0 });
            }
            if(document.getElementById('chk-dahlia').checked) {
                folders.push({ type: 'dah', w: parseInt(document.getElementById('prob-dahlia').value)||0 });
            }
            if(document.getElementById('chk-all-songs').checked) {
                folders.push({ type: 'all', w: parseInt(document.getElementById('prob-all-songs').value)||0 });
            }

            let fHtml = "ãªã—";
            if (folders.length > 0) {
                let totalW = folders.reduce((a,b)=>a+b.w, 0);
                let rnd = Math.random() * totalW;
                let selFolder = null;
                for(const f of folders) {
                    if(rnd < f.w) { selFolder = f; break; }
                    rnd -= f.w;
                }
                if(!selFolder) selFolder = folders[folders.length-1];

                let sObj = null;
                let fName = "";
                const isSong = document.getElementById('mode-song-on').checked;

                if(selFolder.type === 'lvl') {
                    const lMin = parseInt(document.getElementById('level-min').value);
                    const lMax = parseInt(document.getElementById('level-max').value);
                    const lvl = getRandomInt(Math.min(lMin,lMax), Math.max(lMin,lMax));
                    fName = `ãƒ¬ãƒ™ãƒ«ãƒ•ã‚©ãƒ«ãƒ€ â˜…${lvl}`;
                    if(isSong) sObj = pickSongByLevel(lvl);
                } else if(selFolder.type === 'dah') {
                    fName = "ãƒ€ãƒªã‚¢ãƒ•ã‚©ãƒ«ãƒ€";
                    if(isSong) sObj = pickSongByDahlia();
                } else {
                    fName = "å…¨æ›²ãƒ•ã‚©ãƒ«ãƒ€";
                    if(isSong) sObj = pickAnySong();
                }

                if(isSong) {
                    if(sObj) {
                        const fullTitle = `${sObj.song.title_display} ${getDifficultySuffix(sObj.type)}`;
                        fHtml = `<div class="folder-name">${fName}</div><div class="song-info">${fullTitle}</div>`;
                    } else {
                        fHtml = `<div class="folder-name">${fName}</div><div class="folder-name">(è©²å½“æ›²ãªã—)</div>`;
                    }
                } else {
                    fHtml = fName;
                }
            }
            results.push({ label: document.getElementById('mode-song-on').checked ? "ãƒ•ã‚©ãƒ«ãƒ€ï¼†æ¥½æ›²" : "ãƒ•ã‚©ãƒ«ãƒ€", value: fHtml, isSong: true });

            for(let i=0; i<3; i++) {
                const grp = document.querySelector(`.rule-group[data-id="${i}"]`);
                if(grp && grp.querySelector('.rule-enable-chk').checked) {
                    const name = grp.querySelector('.rule-group-name').value || `ã‚ªãƒ—ã‚·ãƒ§ãƒ³${i+1}`;
                    const opts = [];
                    grp.querySelectorAll('.rule-item-row').forEach(row => {
                        opts.push({
                            txt: row.querySelector('input[type="text"]').value,
                            w: parseInt(row.querySelector('.rule-item-prob').value)||0
                        });
                    });
                    
                    let tot = opts.reduce((a,b)=>a+b.w, 0);
                    let rnd = Math.random() * tot;
                    let pick = "---";
                    for(const o of opts) {
                        if(rnd < o.w) { pick = o.txt; break; }
                        rnd -= o.w;
                    }
                    results.push({ label: name, value: pick });
                }
            }

            return results;
        }

        document.getElementById('roll-btn').addEventListener('click', function() {
            const btn = this;
            const resArea = document.getElementById('result-area');
            const finalRes = generateResultsArray();

            resArea.innerHTML = '';
            resArea.style.display = 'block';
            
            finalRes.forEach((r, i) => {
                const d = document.createElement('div');
                d.className = 'result-line';
                d.innerHTML = `<div class="result-label">${r.label}</div><div class="result-value rolling-text" id="rv-${i}">---</div>`;
                resArea.appendChild(d);
            });

            btn.disabled = true;
            btn.textContent = "æŠ½é¸ä¸­...";

            const start = Date.now();
            const locked = new Array(finalRes.length).fill(false);
            const doms = finalRes.map((_, i) => document.getElementById(`rv-${i}`));

            const timer = setInterval(() => {
                const now = Date.now();
                const tempRes = generateResultsArray();
                let done = true;

                finalRes.forEach((target, i) => {
                    if(!locked[i]) {
                        if((now - start) > (2000 + i*1500)) {
                            locked[i] = true;
                            doms[i].innerHTML = target.value;
                            doms[i].className = 'result-value locked-flash';
                        } else {
                            let txt = (tempRes[i] && tempRes[i].value) ? tempRes[i].value : "---";
                            if(target.isSong) {
                                txt = txt.replace(/<div class="song-info"[\s\S]*?>[\s\S]*?<\/div>/, 
                                    '<div class="song-info waiting-text">æ¥½æ›²æŠ½é¸ä¸­...</div>');
                            }
                            doms[i].innerHTML = txt;
                            done = false;
                        }
                    }
                });

                if(done) {
                    clearInterval(timer);
                    btn.disabled = false;
                    btn.textContent = "START";
                }
            }, 50);
        });
    </script>
</body>
</html>

